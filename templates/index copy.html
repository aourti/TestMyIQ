<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive IQ Assessment - Professional Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2em;
        }
        
        .progress-container {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9em;
            color: #333;
            font-weight: bold;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .question h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .question-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
            margin-bottom: 20px;
        }
        
        .difficulty-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }
        
        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }
        
        .options {
            display: grid;
            gap: 15px;
        }
        
        .option {
            background: white;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }
        
        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .text-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
            font-family: monospace;
            letter-spacing: 5px;
        }
        
        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .visual-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .pattern-grid {
            display: inline-grid;
            grid-template-columns: repeat(3, 100px);
            gap: 10px;
            margin: 20px 0;
        }
        
        .pattern-cell {
            width: 100px;
            height: 100px;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: white;
            position: relative;
        }
        
        .pattern-cell.missing {
            border: 3px dashed #999;
            background: #f0f0f0;
            font-size: 36px;
            color: #999;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
        }
        
        .timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .memory-display {
            background: #e7f3ff;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            letter-spacing: 10px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .memory-display.hidden {
            background: #f0f0f0;
            color: #999;
        }
        
        .memory-display.hidden::after {
            content: "Enter the sequence you saw";
            font-size: 0.7em;
            letter-spacing: normal;
        }
        
        .resume-prompt {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .adaptive-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .results {
            text-align: center;
            padding: 40px;
        }
        
        .score-circle {
            width: 200px;
            height: 200px;
            margin: 30px auto;
            position: relative;
        }
        
        .score-circle svg {
            transform: rotate(-90deg);
        }
        
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #333;
        }
        
        .category-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .category-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .category-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .category-score {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .interpretation {
            background: #e7f3ff;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: left;
        }
        
        .interpretation h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .interpretation p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .countdown-timer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 40px;
            border-radius: 20px;
            font-size: 3em;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .age-selector {
            margin: 20px 0;
            text-align: center;
        }
        
        .age-selector label {
            margin-right: 10px;
            font-weight: bold;
        }
        
        .age-selector select {
            padding: 8px 15px;
            font-size: 1.1em;
            border-radius: 5px;
            border: 2px solid #667eea;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .pattern-grid {
                grid-template-columns: repeat(3, 80px);
            }
            
            .pattern-cell {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="timer" id="timer">Time: 0:00</div>
        <div class="countdown-timer" id="countdownTimer"></div>
        
        <div class="header">
            <h1>Adaptive IQ Assessment</h1>
            <p class="subtitle">Professional Cognitive Evaluation System</p>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <!-- Introduction Section -->
        <div class="section active" id="intro">
            <div class="question">
                <h3>Welcome to the Adaptive IQ Assessment</h3>
                
                <div id="resumePrompt" class="resume-prompt" style="display: none;">
                    <p><strong>Previous session detected!</strong></p>
                    <p>Would you like to continue from where you left off?</p>
                    <button class="btn" onclick="resumeTest()">Resume Test</button>
                    <button class="btn btn-secondary" onclick="startNewTest()">Start New Test</button>
                </div>
                
                <div class="adaptive-info">
                    <h4>🎯 Adaptive Testing Technology</h4>
                    <p>This assessment uses Computerized Adaptive Testing (CAT) to precisely measure your cognitive abilities. Questions automatically adjust to your performance level, providing a more accurate and efficient evaluation.</p>
                </div>
                
                <p style="font-size: 1.1em; line-height: 1.6; color: #555; margin-bottom: 20px;">
                    This comprehensive assessment measures five key cognitive domains:
                </p>
                <ul style="list-style: none; padding-left: 0;">
                    <li style="margin: 10px 0;">✓ <strong>Verbal Comprehension</strong> - Language and verbal reasoning</li>
                    <li style="margin: 10px 0;">✓ <strong>Perceptual Reasoning</strong> - Visual-spatial processing</li>
                    <li style="margin: 10px 0;">✓ <strong>Working Memory</strong> - Information retention and manipulation</li>
                    <li style="margin: 10px 0;">✓ <strong>Processing Speed</strong> - Cognitive efficiency</li>
                    <li style="margin: 10px 0;">✓ <strong>Fluid Reasoning</strong> - Novel problem solving</li>
                </ul>
                
                <div class="age-selector">
                    <label for="ageSelect">Select your age:</label>
                    <select id="ageSelect">
                        <option value="12">12 years</option>
                        <option value="13">13 years</option>
                        <option value="14">14 years</option>
                        <option value="15">15 years</option>
                        <option value="16">16 years</option>
                    </select>
                </div>
                
                <p style="font-size: 1.1em; line-height: 1.6; color: #555; margin-top: 20px;">
                    <strong>Important Instructions:</strong>
                </p>
                <ul style="margin-left: 20px;">
                    <li>Find a quiet environment without distractions</li>
                    <li>The test adapts to your responses - expect varying difficulty</li>
                    <li>Your progress is automatically saved</li>
                    <li>Some sections are timed - work efficiently</li>
                    <li>Estimated duration: 45-90 minutes</li>
                </ul>
            </div>
            <div class="navigation">
                <button class="btn" onclick="initializeTest()">Begin Assessment</button>
            </div>
        </div>
        
        <!-- Loading Section -->
        <div class="section" id="loading">
            <div class="loading">
                <h3>Loading Question Bank...</h3>
                <div class="spinner"></div>
                <p>Preparing your personalized assessment</p>
            </div>
        </div>
        
        <!-- Test Container -->
        <div class="section" id="test-container"></div>
        
        <!-- Results Section -->
        <div class="section" id="results">
            <div class="results">
                <h2>Your Assessment Results</h2>
                <div class="score-circle">
                    <svg width="200" height="200">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="#e0e0e0" stroke-width="20"/>
                        <circle id="scoreCircle" cx="100" cy="100" r="90" fill="none" stroke="url(#gradient)" stroke-width="20" stroke-dasharray="565.48" stroke-dashoffset="565.48" stroke-linecap="round"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <div class="score-text" id="finalScore">0</div>
                </div>
                
                <div class="category-scores" id="categoryScores"></div>
                
                <div class="interpretation" id="interpretation"></div>
                
                <div class="navigation">
                    <button class="btn" onclick="generateReport()">Download Detailed Report</button>
                    <button class="btn btn-secondary" onclick="clearAndRestart()">Take Test Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Adaptive Testing Engine
        class AdaptiveTestEngine {
            constructor() {
                this.questionBank = {};
                this.currentDifficulty = {};
                this.responses = [];
                this.domainScores = {};
                this.initialized = false;
            }
            
            async loadQuestionBank() {
                try {
                    // In production, this would fetch from 'questions.json'
                    // For this demo, we'll use embedded questions
                    this.questionBank = this.getDemoQuestions();
                    this.initialized = true;
                    return true;
                } catch (error) {
                    console.error('Failed to load questions:', error);
                    // Fallback to embedded questions
                    this.questionBank = this.getDemoQuestions();
                    this.initialized = true;
                    return true;
                }
            }
            
            getDemoQuestions() {
                // Structured question bank with difficulty levels
                return {
                    "Verbal Comprehension": {
                        easy: [
                            {
                                id: "vc_e1",
                                question: "What does 'happy' mean?",
                                options: ["Sad", "Joyful", "Angry", "Tired"],
                                correct: 1,
                                points: 1
                            },
                            {
                                id: "vc_e2",
                                question: "Which word is the opposite of 'hot'?",
                                options: ["Warm", "Cold", "Wet", "Dry"],
                                correct: 1,
                                points: 1
                            },
                            {
                                id: "vc_e3",
                                question: "Complete: Cat is to kitten as dog is to...",
                                options: ["Puppy", "Cub", "Calf", "Foal"],
                                correct: 0,
                                points: 1
                            }
                        ],
                        medium: [
                            {
                                id: "vc_m1",
                                question: "What does 'meticulous' mean?",
                                options: ["Careless", "Extremely careful and precise", "Very large", "Quick"],
                                correct: 1,
                                points: 2
                            },
                            {
                                id: "vc_m2",
                                question: "Complete the analogy: Painter is to brush as writer is to...",
                                options: ["Paper", "Pen", "Book", "Reader"],
                                correct: 1,
                                points: 2
                            },
                            {
                                id: "vc_m3",
                                question: "Which word does NOT belong?",
                                options: ["Crimson", "Scarlet", "Azure", "Ruby"],
                                correct: 2,
                                points: 2
                            },
                            {
                                id: "vc_m4",
                                question: "What is the opposite of 'abundant'?",
                                options: ["Plentiful", "Scarce", "Heavy", "Rich"],
                                correct: 1,
                                points: 2
                            }
                        ],
                        hard: [
                            {
                                id: "vc_h1",
                                question: "What does 'ubiquitous' mean?",
                                options: ["Rare", "Present everywhere", "Difficult", "Changing"],
                                correct: 1,
                                points: 3
                            },
                            {
                                id: "vc_h2",
                                question: "If all A are B, and all B are C, then:",
                                options: ["Some A are C", "All A are C", "No A are C", "Some C are not A"],
                                correct: 1,
                                points: 3
                            },
                            {
                                id: "vc_h3",
                                question: "The word 'ephemeral' most nearly means:",
                                options: ["Eternal", "Solid", "Short-lived", "Beautiful"],
                                correct: 2,
                                points: 3
                            }
                        ]
                    },
                    "Perceptual Reasoning": {
                        easy: [
                            {
                                id: "pr_e1",
                                type: "pattern",
                                question: "What comes next? ○ ● ○ ● ○ ?",
                                options: ["○", "●", "□", "△"],
                                correct: 1,
                                points: 1
                            },
                            {
                                id: "pr_e2",
                                type: "sequence",
                                question: "What number comes next? 2, 4, 6, 8, ?",
                                options: ["9", "10", "11", "12"],
                                correct: 1,
                                points: 1
                            },
                            {
                                id: "pr_e3",
                                type: "pattern",
                                question: "Complete the pattern: △ △ □ △ △ □ △ △ ?",
                                options: ["△", "□", "○", "●"],
                                correct: 1,
                                points: 1
                            }
                        ],
                        medium: [
                            {
                                id: "pr_m1",
                                type: "sequence",
                                question: "What number comes next? 2, 4, 8, 16, ?",
                                options: ["24", "32", "20", "30"],
                                correct: 1,
                                points: 2
                            },
                            {
                                id: "pr_m2",
                                type: "sequence",
                                question: "Find the pattern: 1, 4, 9, 16, 25, ?",
                                options: ["30", "35", "36", "40"],
                                correct: 2,
                                points: 2
                            },
                            {
                                id: "pr_m3",
                                type: "pattern",
                                question: "In the sequence: 3, 6, 12, 24, ?",
                                options: ["36", "48", "30", "42"],
                                correct: 1,
                                points: 2
                            }
                        ],
                        hard: [
                            {
                                id: "pr_h1",
                                type: "matrix",
                                question: "Complete the 3x3 pattern where each row and column has unique shapes",
                                matrix: [
                                    ["●", "■", "▲"],
                                    ["■", "▲", "●"],
                                    ["▲", "●", "?"]
                                ],
                                options: ["●", "■", "▲", "♦"],
                                correct: 1,
                                points: 3
                            },
                            {
                                id: "pr_h2",
                                type: "sequence",
                                question: "Find the pattern: 2, 3, 5, 8, 13, ?",
                                options: ["18", "20", "21", "24"],
                                correct: 2,
                                points: 3
                            }
                        ]
                    },
                    "Working Memory": {
                        easy: [
                            {
                                id: "wm_e1",
                                type: "digit-span",
                                question: "Remember this sequence:",
                                length: 3,
                                displayTime: 3000,
                                inputType: "text",
                                points: 1
                            },
                            {
                                id: "wm_e2",
                                type: "digit-span",
                                question: "Remember this sequence:",
                                length: 3,
                                displayTime: 3000,
                                inputType: "text",
                                points: 1
                            }
                        ],
                        medium: [
                            {
                                id: "wm_m1",
                                type: "digit-span",
                                question: "Remember this sequence:",
                                length: 5,
                                displayTime: 4000,
                                inputType: "text",
                                points: 2
                            },
                            {
                                id: "wm_m2",
                                type: "digit-span",
                                question: "Remember this sequence:",
                                length: 5,
                                displayTime: 4000,
                                inputType: "text",
                                points: 2
                            }
                        ],
                        hard: [
                            {
                                id: "wm_h1",
                                type: "digit-span-reverse",
                                question: "Remember and enter in REVERSE order:",
                                length: 5,
                                displayTime: 5000,
                                inputType: "text",
                                points: 3
                            },
                            {
                                id: "wm_h2",
                                type: "digit-span-reverse",
                                question: "Remember and enter in REVERSE order:",
                                length: 5,
                                displayTime: 5000,
                                inputType: "text",
                                points: 3
                            }
                        ]
                    },
                    "Processing Speed": {
                        easy: [
                            {
                                id: "ps_e1",
                                type: "symbol-search",
                                question: "Count how many times '◆' appears: ◆○□◆△◆○◆",
                                options: ["3", "4", "5", "6"],
                                correct: 1,
                                points: 1,
                                timeLimit: 15
                            },
                            {
                                id: "ps_e2",
                                type: "symbol-search",
                                question: "Count how many circles (○) appear: ○●○○●○●○",
                                options: ["3", "4", "5", "6"],
                                correct: 2,
                                points: 1,
                                timeLimit: 15
                            }
                        ],
                        medium: [
                            {
                                id: "ps_m1",
                                type: "coding",
                                question: "Using A=1, B=2, C=3, D=4, E=5, what is BEAD?",
                                options: ["2514", "2541", "2154", "2415"],
                                correct: 0,
                                points: 2,
                                timeLimit: 20
                            },
                            {
                                id: "ps_m2",
                                type: "coding",
                                question: "Using A=1, B=2, C=3, D=4, E=5, what is DECADE?",
                                options: ["453145", "451345", "453154", "145345"],
                                correct: 0,
                                points: 2,
                                timeLimit: 25
                            }
                        ],
                        hard: [
                            {
                                id: "ps_h1",
                                type: "complex-search",
                                question: "Count letters that appear exactly twice in: MISSISSIPPI",
                                options: ["0", "1", "2", "3"],
                                correct: 1,
                                points: 3,
                                timeLimit: 15
                            },
                            {
                                id: "ps_h2",
                                type: "complex-search",
                                question: "How many vowels (A,E,I,O,U) in: ENCYCLOPEDIA",
                                options: ["4", "5", "6", "7"],
                                correct: 1,
                                points: 3,
                                timeLimit: 20
                            }
                        ]
                    },
                    "Fluid Reasoning": {
                        easy: [
                            {
                                id: "fr_e1",
                                type: "logic",
                                question: "If all cats are animals, and Fluffy is a cat, what is Fluffy?",
                                options: ["A dog", "An animal", "A bird", "Unknown"],
                                correct: 1,
                                points: 1
                            },
                            {
                                id: "fr_e2",
                                type: "logic",
                                question: "If it's raining, the ground is wet. The ground is wet. Therefore:",
                                options: ["It's definitely raining", "It might be raining", "It's not raining", "The sun is shining"],
                                correct: 1,
                                points: 1
                            }
                        ],
                        medium: [
                            {
                                id: "fr_m1",
                                type: "logic",
                                question: "In a race, you overtake the 2nd place person. What position are you?",
                                options: ["1st", "2nd", "3rd", "4th"],
                                correct: 1,
                                points: 2
                            },
                            {
                                id: "fr_m2",
                                type: "logic",
                                question: "If 5 machines make 5 widgets in 5 minutes, how long for 100 machines to make 100 widgets?",
                                options: ["1 minute", "5 minutes", "100 minutes", "500 minutes"],
                                correct: 1,
                                points: 2
                            }
                        ],
                        hard: [
                            {
                                id: "fr_h1",
                                type: "logic",
                                question: "A bat and ball cost $1.10. The bat costs $1 more than the ball. Ball cost?",
                                options: ["$0.10", "$0.05", "$0.15", "$0.20"],
                                correct: 1,
                                points: 3
                            },
                            {
                                id: "fr_h2",
                                type: "logic",
                                question: "In a group of 30 people, 18 like coffee, 15 like tea, and 8 like both. How many like neither?",
                                options: ["3", "5", "7", "9"],
                                correct: 1,
                                points: 3
                            }
                        ]
                    }
                };
            }
            
            getNextQuestion(domain, previousCorrect = null) {
                if (!this.currentDifficulty[domain]) {
                    this.currentDifficulty[domain] = 'medium';
                }
                
                let difficulty = this.currentDifficulty[domain];
                
                // Adaptive logic
                if (previousCorrect !== null) {
                    if (previousCorrect && difficulty !== 'hard') {
                        difficulty = difficulty === 'easy' ? 'medium' : 'hard';
                    } else if (!previousCorrect && difficulty !== 'easy') {
                        difficulty = difficulty === 'hard' ? 'medium' : 'easy';
                    }
                    this.currentDifficulty[domain] = difficulty;
                }
                
                const questions = this.questionBank[domain][difficulty];
                const availableQuestions = questions.filter(q => 
                    !this.responses.find(r => r.questionId === q.id)
                );
                
                if (availableQuestions.length === 0) {
                    // Try other difficulties
                    const difficulties = ['easy', 'medium', 'hard'].filter(d => d !== difficulty);
                    for (const d of difficulties) {
                        const altQuestions = this.questionBank[domain][d].filter(q => 
                            !this.responses.find(r => r.questionId === q.id)
                        );
                        if (altQuestions.length > 0) {
                            // Randomly select from available questions
                            const randomIndex = Math.floor(Math.random() * altQuestions.length);
                            return { ...altQuestions[randomIndex], difficulty: d };
                        }
                    }
                    return null;
                }
                
                // Randomly select from available questions
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                return { ...availableQuestions[randomIndex], difficulty };
            }
            
            recordResponse(domain, questionId, correct, responseTime, difficulty) {
                this.responses.push({
                    domain,
                    questionId,
                    correct,
                    responseTime,
                    difficulty,
                    timestamp: Date.now()
                });
                
                if (!this.domainScores[domain]) {
                    this.domainScores[domain] = {
                        correct: 0,
                        total: 0,
                        points: 0,
                        difficulties: { easy: 0, medium: 0, hard: 0 }
                    };
                }
                
                this.domainScores[domain].total++;
                if (correct) {
                    this.domainScores[domain].correct++;
                    this.domainScores[domain].points += this.getDifficultyPoints(difficulty);
                }
                this.domainScores[domain].difficulties[difficulty]++;
            }
            
            getDifficultyPoints(difficulty) {
                const points = { easy: 1, medium: 2, hard: 3 };
                return points[difficulty] || 1;
            }
            
            shouldContinueDomain(domain) {
                const score = this.domainScores[domain];
                if (!score || score.total < 3) return true;
                
                // Stop if we have at least 10 questions or a clear pattern
                if (score.total >= 10) return false;
                
                // Stop if consistent performance
                const recentResponses = this.responses
                    .filter(r => r.domain === domain)
                    .slice(-3);
                
                const allCorrect = recentResponses.every(r => r.correct);
                const allIncorrect = recentResponses.every(r => !r.correct);
                
                if ((allCorrect && this.currentDifficulty[domain] === 'hard') ||
                    (allIncorrect && this.currentDifficulty[domain] === 'easy')) {
                    return false;
                }
                
                return true;
            }
        }
        
        // Global variables
        let testEngine = new AdaptiveTestEngine();
        let currentDomain = '';
        let currentQuestion = null;
        let domainIndex = 0;
        let startTime;
        let timerInterval;
        let questionTimer;
        let questionStartTime;
        let userAge = 12;
        const domains = ["Verbal Comprehension", "Perceptual Reasoning", "Working Memory", "Processing Speed", "Fluid Reasoning"];
        
        // Check for saved session on load
        window.addEventListener('load', () => {
            checkSavedSession();
        });
        
        function checkSavedSession() {
            const savedState = localStorage.getItem('iqTestState');
            if (savedState) {
                document.getElementById('resumePrompt').style.display = 'block';
            }
        }
        
        function resumeTest() {
            const savedState = JSON.parse(localStorage.getItem('iqTestState'));
            if (savedState) {
                // Restore state
                testEngine.responses = savedState.responses || [];
                testEngine.domainScores = savedState.domainScores || {};
                testEngine.currentDifficulty = savedState.currentDifficulty || {};
                domainIndex = savedState.domainIndex || 0;
                userAge = savedState.userAge || 12;
                startTime = Date.now() - (savedState.elapsedTime || 0);
                
                // Load questions and continue
                initializeTest(true);
            }
        }
        
        function startNewTest() {
            localStorage.removeItem('iqTestState');
            document.getElementById('resumePrompt').style.display = 'none';
        }
        
        function clearAndRestart() {
            localStorage.removeItem('iqTestState');
            location.reload();
        }
        
        async function initializeTest(resuming = false) {
            if (!resuming) {
                userAge = parseInt(document.getElementById('ageSelect').value);
            }
            
            document.getElementById('intro').classList.remove('active');
            document.getElementById('loading').classList.add('active');
            
            // Load question bank
            await testEngine.loadQuestionBank();
            
            setTimeout(() => {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('test-container').classList.add('active');
                
                if (!resuming) {
                    startTime = Date.now();
                }
                startTimer();
                
                if (resuming && domainIndex < domains.length) {
                    currentDomain = domains[domainIndex];
                    showNextQuestion();
                } else {
                    showSectionIntro();
                }
            }, 1000);
        }
        
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function showSectionIntro() {
            if (domainIndex >= domains.length) {
                showResults();
                return;
            }
            
            currentDomain = domains[domainIndex];
            const html = `
                <div class="question">
                    <h2>${currentDomain}</h2>
                    <p class="question-text">${getSectionDescription(currentDomain)}</p>
                    <div class="adaptive-info">
                        <p><strong>Adaptive Testing:</strong> Questions will adjust to your performance level.</p>
                        <p>Starting with medium difficulty questions.</p>
                    </div>
                </div>
                <div class="navigation">
                    <button class="btn" onclick="startSection()">Begin Section</button>
                </div>
            `;
            document.getElementById('test-container').innerHTML = html;
        }
        
        function getSectionDescription(domain) {
            const descriptions = {
                "Verbal Comprehension": "This section measures your understanding of language, vocabulary, and verbal reasoning.",
                "Perceptual Reasoning": "This section tests your ability to analyze visual information and recognize patterns.",
                "Working Memory": "This section tests your ability to remember and manipulate information. You'll need to type responses from memory.",
                "Processing Speed": "This section measures how quickly and accurately you can process information. Work as fast as you can!",
                "Fluid Reasoning": "This section tests your ability to solve new problems using logic and reasoning."
            };
            return descriptions[domain];
        }
        
        function startSection() {
            showNextQuestion();
        }
        
        function showNextQuestion() {
            clearInterval(questionTimer);
            
            // Check if we should continue this domain
            if (!testEngine.shouldContinueDomain(currentDomain)) {
                domainIndex++;
                saveState();
                showSectionIntro();
                return;
            }
            
            // Get adaptive question
            const lastResponse = testEngine.responses
                .filter(r => r.domain === currentDomain)
                .pop();
            
            currentQuestion = testEngine.getNextQuestion(
                currentDomain,
                lastResponse ? lastResponse.correct : null
            );
            
            if (!currentQuestion) {
                domainIndex++;
                saveState();
                showSectionIntro();
                return;
            }
            
            questionStartTime = Date.now();
            displayQuestion(currentQuestion);
        }
        
        function displayQuestion(question) {
            if (question.type && question.type.includes('digit-span') && question.length) {
                const sequence = generateRandomSequence(question.length);
                question.sequence = sequence; // This is the sequence to show the user (e.g., "4-7-2")
                question.correct = sequence.replace(/-/g, ''); // This is the correct answer (e.g., "472")
            }

            let html = `
                <div class="question">
                    <h3>${currentDomain}</h3>
                    <span class="difficulty-indicator difficulty-${question.difficulty}">
                        ${question.difficulty.toUpperCase()} DIFFICULTY
                    </span>
            `;
            
            // Handle different question types
            if (question.type === 'matrix') {
                html += `
                    <p class="question-text">${question.question}</p>
                    <div class="visual-container">
                        <div class="pattern-grid">
                `;
                question.matrix.forEach(row => {
                    row.forEach(cell => {
                        if (cell === '?') {
                            html += `<div class="pattern-cell missing">?</div>`;
                        } else {
                            html += `<div class="pattern-cell">${cell}</div>`;
                        }
                    });
                });
                html += `</div></div>`;
                
            } else if (question.type && question.type.includes('digit-span')) {
                html += `
                    <p class="question-text">${question.question}</p>
                    <div class="memory-display" id="memoryDisplay">${question.sequence}</div>
                    <div id="memoryInput" style="display: none;">
                        <input type="text" class="text-input" id="textAnswer" placeholder="Enter the sequence" 
                               onkeyup="enableSubmitForText()" autocomplete="off">
                    </div>
                `;
                
                // Hide sequence and show input after display time
                setTimeout(() => {
                    const display = document.getElementById('memoryDisplay');
                    const input = document.getElementById('memoryInput');
                    if (display && input) {
                        display.textContent = '';
                        display.classList.add('hidden');
                        input.style.display = 'block';
                        document.getElementById('textAnswer').focus();
                    }
                }, question.displayTime);
                
            } else {
                html += `<p class="question-text">${question.question}</p>`;
            }
            
            // Add options for non-memory questions
            if (!question.inputType || question.inputType !== 'text') {
                html += '<div class="options">';
                question.options.forEach((option, index) => {
                    html += `
                        <div class="option" onclick="selectAnswer(${index})">
                            ${option}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            // Add navigation
            const isTextInput = question.inputType === 'text';
            html += `
                <div class="navigation">
                    <button class="btn" id="submitBtn" onclick="submitAnswer()" 
                            ${isTextInput ? 'disabled' : ''}>Submit Answer</button>
                </div>
            `;
            
            document.getElementById('test-container').innerHTML = html;
            updateProgress();
            
            // Handle timed questions
            if (question.timeLimit) {
                let timeLeft = question.timeLimit;
                const countdownDiv = document.getElementById('countdownTimer');
                countdownDiv.style.display = 'block';
                countdownDiv.textContent = timeLeft;
                
                questionTimer = setInterval(() => {
                    timeLeft--;
                    countdownDiv.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(questionTimer);
                        countdownDiv.style.display = 'none';
                        submitAnswer();
                    }
                }, 1000);
            }
        }
        
        function selectAnswer(index) {
            document.querySelectorAll('.option').forEach((opt, i) => {
                opt.classList.toggle('selected', i === index);
            });
            document.getElementById('submitBtn').disabled = false;
        }
        
        function enableSubmitForText() {
            const input = document.getElementById('textAnswer');
            document.getElementById('submitBtn').disabled = !input.value.trim();
        }
        
        function submitAnswer() {
            clearInterval(questionTimer);
            document.getElementById('countdownTimer').style.display = 'none';
            
            let isCorrect = false;
            const responseTime = Date.now() - questionStartTime;
            
            if (currentQuestion.inputType === 'text') {
                const userAnswer = document.getElementById('textAnswer').value.replace(/[-\s]/g, '');
                isCorrect = userAnswer === currentQuestion.correct;
            } else {
                const selected = document.querySelector('.option.selected');
                if (selected) {
                    const selectedIndex = Array.from(document.querySelectorAll('.option')).indexOf(selected);
                    isCorrect = selectedIndex === currentQuestion.correct;
                }
            }
            
            // Record response
            testEngine.recordResponse(
                currentDomain,
                currentQuestion.id,
                isCorrect,
                responseTime,
                currentQuestion.difficulty
            );
            
            // Save state after each answer
            saveState();
            
            // Show next question
            showNextQuestion();
        }
        
        function updateProgress() {
            const totalQuestions = testEngine.responses.length;
            const estimatedTotal = domains.length * 8; // Approximate
            const progress = Math.round((totalQuestions / estimatedTotal) * 100);
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
        }
        
        function saveState() {
            const state = {
                responses: testEngine.responses,
                domainScores: testEngine.domainScores,
                currentDifficulty: testEngine.currentDifficulty,
                domainIndex: domainIndex,
                userAge: userAge,
                elapsedTime: Date.now() - startTime
            };
            localStorage.setItem('iqTestState', JSON.stringify(state));
        }
        
        function showResults() {
            clearInterval(timerInterval);
            document.getElementById('test-container').classList.remove('active');
            document.getElementById('results').classList.add('active');
            
            // Clear saved state
            localStorage.removeItem('iqTestState');
            
            const results = calculateAdaptiveIQ();
            const iq = results.fsiq;
            document.getElementById('finalScore').textContent = iq;
            
            // Animate score circle
            const circle = document.getElementById('scoreCircle');
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (circumference * ((iq - 40) / 120));
            
            setTimeout(() => {
                circle.style.strokeDashoffset = offset;
                circle.style.transition = 'stroke-dashoffset 2s ease-out';
            }, 100);
            
            // Show domain scores
            let categoryHTML = '';
            Object.keys(testEngine.domainScores).forEach(domain => {
                const domainScore = results.domainScores[domain];
                const data = testEngine.domainScores[domain];
                const accuracy = Math.round((data.correct / data.total) * 100);
                
                categoryHTML += `
                    <div class="category-card">
                        <h4>${domain}</h4>
                        <div class="category-score">${domainScore}</div>
                        <p>Accuracy: ${accuracy}%</p>
                        <p style="font-size: 0.9em; color: #666;">
                            E:${data.difficulties.easy} M:${data.difficulties.medium} H:${data.difficulties.hard}
                        </p>
                    </div>
                `;
            });
            
            document.getElementById('categoryScores').innerHTML = categoryHTML;
            document.getElementById('interpretation').innerHTML = generateAdaptiveInterpretation(iq, results.domainScores);
        }
        
        function calculateAdaptiveIQ() {
            const domainScores = {};
            let totalPoints = 0;
            let maxPossiblePoints = 0;
            
            // Calculate domain scores based on adaptive performance
            Object.keys(testEngine.domainScores).forEach(domain => {
                const data = testEngine.domainScores[domain];
                
                if (data.total === 0) {
                    domainScores[domain] = 100; // Default if no questions answered
                    return;
                }
                
                // Calculate actual points earned
                let earnedPoints = 0;
                let possiblePoints = 0;
                
                testEngine.responses
                    .filter(r => r.domain === domain)
                    .forEach(response => {
                        const difficultyMultiplier = {
                            'easy': 1,
                            'medium': 2,
                            'hard': 3
                        };
                        const points = difficultyMultiplier[response.difficulty] || 1;
                        possiblePoints += points;
                        if (response.correct) {
                            earnedPoints += points;
                        }
                    });
                
                // Calculate percentage with difficulty weighting
                const percentage = possiblePoints > 0 ? earnedPoints / possiblePoints : 0;
                
                // Account for difficulty reached
                let difficultyBonus = 0;
                if (testEngine.currentDifficulty[domain] === 'hard' && data.correct / data.total > 0.5) {
                    difficultyBonus = 0.15;
                } else if (testEngine.currentDifficulty[domain] === 'medium' && data.correct / data.total > 0.6) {
                    difficultyBonus = 0.05;
                }
                
                // Convert to IQ scale (domain score)
                const adjustedPercentage = Math.min(1, percentage + difficultyBonus);
                const zScore = (adjustedPercentage - 0.5) * 3; // Spread the scores
                const domainIQ = Math.round(100 + (zScore * 15));
                
                domainScores[domain] = Math.max(70, Math.min(130, domainIQ));
                
                totalPoints += earnedPoints;
                maxPossiblePoints += possiblePoints;
            });
            
            // Calculate Full Scale IQ based on overall performance
            const overallPercentage = maxPossiblePoints > 0 ? totalPoints / maxPossiblePoints : 0.5;
            
            // Consider adaptive difficulty reached
            let difficultyAdjustment = 0;
            const difficulties = Object.values(testEngine.currentDifficulty);
            const hardCount = difficulties.filter(d => d === 'hard').length;
            const easyCount = difficulties.filter(d => d === 'easy').length;
            
            if (hardCount >= 3) difficultyAdjustment = 5;
            else if (hardCount >= 2) difficultyAdjustment = 3;
            else if (easyCount >= 3) difficultyAdjustment = -5;
            else if (easyCount >= 2) difficultyAdjustment = -3;
            
            // Calculate FSIQ with more variance based on actual performance
            const baseIQ = 85 + (overallPercentage * 60); // Range: 85-145
            const fsiq = Math.round(baseIQ + difficultyAdjustment);
            
            return {
                fsiq: Math.max(70, Math.min(145, fsiq)),
                domainScores: domainScores,
                overallAccuracy: overallPercentage
            };
        }
        
        function generateAdaptiveInterpretation(iq, domainScores) {
            let html = '<h3>Adaptive Testing Results</h3>';
            
            const classification = getClassification(iq);
            const percentile = getPercentile(iq);
            
            html += `
                <p><strong>Full Scale IQ:</strong> ${iq} (${percentile}th percentile)</p>
                <p><strong>Classification:</strong> ${classification}</p>
                <p><strong>Age at Testing:</strong> ${userAge} years</p>
                <p><strong>Test Type:</strong> Computerized Adaptive Testing (CAT)</p>
            `;
            
            // Adaptive testing summary
            html += `
                <h4 style="margin-top: 20px;">Adaptive Performance Summary</h4>
                <p>The test adapted to your performance across ${testEngine.responses.length} questions:</p>
                <ul>
            `;
            
            Object.keys(testEngine.domainScores).forEach(domain => {
                const data = testEngine.domainScores[domain];
                const finalDifficulty = testEngine.currentDifficulty[domain] || 'medium';
                html += `<li><strong>${domain}:</strong> Stabilized at ${finalDifficulty} difficulty</li>`;
            });
            
            html += '</ul>';
            
            // Standard interpretation
            if (iq >= 130) {
                html += `<p>Your performance indicates exceptionally advanced cognitive abilities.</p>`;
            } else if (iq >= 120) {
                html += `<p>Your performance reflects superior intellectual functioning.</p>`;
            } else if (iq >= 110) {
                html += `<p>Your performance represents high average intellectual ability.</p>`;
            } else if (iq >= 90) {
                html += `<p>Your performance falls within the average range of intellectual functioning.</p>`;
            } else {
                html += `<p>Your performance suggests areas where additional support may be beneficial.</p>`;
            }
            
            return html;
        }
        
        function getClassification(iq) {
            if (iq >= 130) return "Very Superior";
            if (iq >= 120) return "Superior";
            if (iq >= 110) return "High Average";
            if (iq >= 90) return "Average";
            if (iq >= 80) return "Low Average";
            if (iq >= 70) return "Borderline";
            return "Extremely Low";
        }
        
        function getPercentile(iq) {
            const zScore = (iq - 100) / 15;
            const percentile = normalCDF(zScore) * 100;
            return Math.round(percentile);
        }
        
        function normalCDF(z) {
            const a1 = 0.254829592;
            const a2 = -0.284496736;
            const a3 = 1.421413741;
            const a4 = -1.453152027;
            const a5 = 1.061405429;
            const p = 0.3275911;
            
            const sign = z < 0 ? -1 : 1;
            z = Math.abs(z) / Math.sqrt(2);
            
            const t = 1 / (1 + p * z);
            const y = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);
            
            return 0.5 * (1 + sign * y);
        }
        
        function generateReport() {
            const results = calculateAdaptiveIQ();
            const testDuration = Math.floor((Date.now() - startTime) / 1000);
            
            let report = `ADAPTIVE IQ ASSESSMENT REPORT\n`;
            report += `${'='.repeat(50)}\n\n`;
            report += `Assessment Type: Computerized Adaptive Testing (CAT)\n`;
            report += `Assessment Date: ${new Date().toLocaleDateString()}\n`;
            report += `Test Duration: ${Math.floor(testDuration / 60)} minutes ${testDuration % 60} seconds\n`;
            report += `Age at Testing: ${userAge} years\n`;
            report += `Total Questions: ${testEngine.responses.length}\n\n`;
            
            report += `SUMMARY OF RESULTS\n`;
            report += `${'-'.repeat(30)}\n`;
            report += `Full Scale IQ (FSIQ): ${results.fsiq}\n`;
            report += `Percentile Rank: ${getPercentile(results.fsiq)}\n`;
            report += `Classification: ${getClassification(results.fsiq)}\n\n`;
            
            report += `ADAPTIVE TESTING METRICS\n`;
            report += `${'-'.repeat(30)}\n`;
            
            Object.keys(testEngine.domainScores).forEach(domain => {
                const data = testEngine.domainScores[domain];
                report += `\n${domain}:\n`;
                report += `  Final Difficulty: ${testEngine.currentDifficulty[domain] || 'medium'}\n`;
                report += `  Questions: ${data.total} (E:${data.difficulties.easy} M:${data.difficulties.medium} H:${data.difficulties.hard})\n`;
                report += `  Accuracy: ${Math.round((data.correct / data.total) * 100)}%\n`;
                report += `  Domain Score: ${results.domainScores[domain]}\n`;
            });
            
            report += `\n\nDETAILED RESPONSE ANALYSIS\n`;
            report += `${'-'.repeat(30)}\n`;
            
            // Analyze response patterns
            const avgResponseTime = testEngine.responses.reduce((sum, r) => sum + r.responseTime, 0) / testEngine.responses.length;
            report += `Average Response Time: ${Math.round(avgResponseTime / 1000)} seconds\n`;
            
            // Performance by difficulty
            const byDifficulty = { easy: { correct: 0, total: 0 }, medium: { correct: 0, total: 0 }, hard: { correct: 0, total: 0 } };
            testEngine.responses.forEach(r => {
                byDifficulty[r.difficulty].total++;
                if (r.correct) byDifficulty[r.difficulty].correct++;
            });
            
            report += `\nPerformance by Difficulty:\n`;
            Object.keys(byDifficulty).forEach(level => {
                const data = byDifficulty[level];
                if (data.total > 0) {
                    report += `  ${level.toUpperCase()}: ${Math.round((data.correct / data.total) * 100)}% (${data.correct}/${data.total})\n`;
                }
            });
            
            report += `\n\nADAPTIVE ALGORITHM NOTES\n`;
            report += `${'-'.repeat(30)}\n`;
            report += `This assessment used Computerized Adaptive Testing (CAT) to:\n`;
            report += `- Adjust question difficulty based on real-time performance\n`;
            report += `- Reduce test length while maintaining accuracy\n`;
            report += `- Provide more precise ability estimates\n`;
            report += `- Minimize floor and ceiling effects\n`;
            
            report += `\n\nDISCLAIMER\n`;
            report += `${'-'.repeat(30)}\n`;
            report += `This adaptive assessment provides educational insights only.\n`;
            report += `For clinical or diagnostic purposes, consult a qualified professional.\n`;
            
            // Download report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Adaptive_IQ_Report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Adaptive assessment report downloaded successfully!');
        }

        function generateRandomSequence(length) {
            const digits = [];
            for (let i = 0; i < length; i++) {
                digits.push(Math.floor(Math.random() * 10)); // Random digit 0-9
            }
            return digits.join('-'); // Returns a string like "4-7-2"
        }
    </script>
</body>
</html>